# Backend Implementation Plan

*Auto-generated by Ralph during planning mode.*

## Status

- **State:** Planning Complete — Ready for Implementation
- **Last Updated:** 2026-02-09
- **Total Tasks:** 25 prioritized tasks
- **Phase:** Greenfield build — no existing backend code

---

## Summary

The backend is a **greenfield project** — the `src/backend/` directory is currently empty. This plan outlines a phased approach to building the complete Forge backend system based on the 12 specification documents.

### System Architecture Overview
Forge is an autonomous software engineering system with:
- **Captain Agent**: Conducts planning interviews, produces specs/tasks/DAG
- **Executor Loop**: Orchestrates task execution across DAG
- **Agent Types**: Hierarchy of workers (Type 1, 2, 3, Refinery)
- **Artifact Store**: Centralized storage for all run artifacts
- **E2B Sandboxes**: Isolated execution environments for agents
- **REST API + SDK**: Express.js with NDJSON streaming

### Tech Stack
- **Runtime**: Node.js with TypeScript
- **Framework**: Express.js
- **LLM Integration**: forge-ai (fork of pi-ai)
- **Agent Core**: forge-agent (fork of pi-agent-core)
- **Sandbox**: E2B (@e2b/code-interpreter)
- **Web Search**: Exa AI (exa-js)
- **Simulation FS**: just-bash
- **Validation**: TypeBox + AJV

---

## Prioritized Tasks

### Phase 1: Foundation & Core Infrastructure (Priority: Critical)

#### Task 1.1: Project Scaffolding and Configuration
**Complexity:** Small  
**Description:** Initialize the backend project with TypeScript, ESLint, Prettier, and testing infrastructure.

**Status:** Completed (2026-02-09)

**Deliverables:**
- `src/backend/package.json` with all dependencies
- `src/backend/tsconfig.json` configured for Node.js
- ESLint + Prettier configuration
- Jest or Vitest test setup
- npm scripts: `dev`, `build`, `start`, `test`, `lint`, `typecheck`

**Dependencies:** None  

**Required Tests:**
- TypeScript compiles without errors
- Linting passes
- Test runner executes successfully

---

#### Task 1.2: Fork and Integrate forge-ai (from pi-ai)
**Complexity:** Medium  
**Description:** Fork `@mariozechner/pi-ai` from badlogic/pi-mono as `forge-ai`. Keep everything — unified LLM API, model registry, streaming, tools, cost tracking.

**Deliverables:**
- `src/backend/packages/forge-ai/` with complete pi-ai fork
- Renamed exports and package.json
- Updated imports to use `forge-ai`
- Preserved all 20+ provider implementations

**Dependencies:** Task 1.1  

**Required Tests:**
- Unit tests for model registry
- Integration tests for at least 2 providers (OpenAI, Anthropic)
- Streaming event parsing tests
- Tool validation tests with TypeBox

**Acceptance Criteria (from spec 11):**
- All KnownProvider types work
- AssistantMessageEvent discriminated union types preserved
- Cost calculation works for all registered models

---

#### Task 1.3: Fork and Integrate forge-agent (from pi-agent-core)
**Complexity:** Medium  
**Description:** Fork `@mariozechner/pi-agent-core` from badlogic/pi-mono as `forge-agent`. Keep everything — Agent class, inner/outer loop, steering/follow-up queues, events.

**Deliverables:**
- `src/backend/packages/forge-agent/` with complete pi-agent-core fork
- Custom message declaration merging setup for Forge-specific messages
- EventStream async iterable preserved

**Dependencies:** Task 1.2  

**Required Tests:**
- Agent lifecycle tests (prompt, continue, abort, waitForIdle)
- Steering queue interrupt tests
- Follow-up queue continuation tests
- Event emission tests for all AgentEvent types
- Tool execution sequence tests

**Acceptance Criteria (from spec 11):**
- Agent inner/outer loop functions correctly
- Steering interrupts mid-turn tool execution
- Follow-up messages wait until idle
- Custom messages via declaration merging work

---

#### Task 1.4: Artifact Store Implementation
**Complexity:** Medium  
**Description:** Implement the centralized artifact store using just-bash for filesystem simulation. All artifacts stored at `artifacts/<runId>/`.

**Deliverables:**
- `src/backend/lib/artifact-store.ts` — ArtifactStore class
- Atomic write protocol (write → fsync → rename)
- Directory structure creation
- Read/write operations for all artifact types

**Directory Structure:**
```
artifacts/<runId>/
├── specs/
├── tasks/
├── dag.json
├── dag-status.json
├── run-state.json
├── change-requests/
└── <taskId>/<attemptId>/walkthrough.md
```

**Dependencies:** Task 1.1  

**Required Tests:**
- Atomic write prevents partial reads
- Correct directory structure creation
- All artifact types can be read/written
- Concurrent read safety
- Error handling for missing files

**Acceptance Criteria (from spec 08):**
- Walkthrough format with YAML frontmatter validated
- DAG JSON schema validated
- Run state lifecycle correct
- Change request overlay application works

---

### Phase 2: API Layer & Event Streaming (Priority: High)

#### Task 2.1: Express.js Server Setup
**Complexity:** Small  
**Description:** Set up Express.js server with middleware, error handling, and CORS configuration for localhost.

**Deliverables:**
- `src/backend/server.ts` — Main entry point
- `src/backend/middleware/` — Error handling, request logging
- CORS configured for localhost origins
- Health check endpoint

**Dependencies:** Task 1.1  

**Required Tests:**
- Server starts on configured port
- Health check returns 200
- Error middleware formats errors correctly
- CORS allows localhost origins

---

#### Task 2.2: REST API Endpoints - Runs
**Complexity:** Medium  
**Description:** Implement run management endpoints: create, get, pause, resume.

**Endpoints:**
| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/api/v1/runs` | Create a new run |
| `GET` | `/api/v1/runs/:runId` | Get run state |
| `POST` | `/api/v1/runs/:runId/pause` | Pause run |
| `POST` | `/api/v1/runs/:runId/resume` | Resume paused run |

**Dependencies:** Task 1.4, Task 2.1  

**Required Tests:**
- Create run initializes artifact structure
- Get run returns correct RunState
- Pause transitions status correctly (409 if already paused)
- Resume transitions status correctly (409 if not paused)
- Invalid runId returns 404

**Acceptance Criteria (from spec 09):**
- Standard error envelope on failures
- Correct HTTP status codes (201, 200, 404, 409)

---

#### Task 2.3: NDJSON Event Stream Implementation
**Complexity:** Medium  
**Description:** Implement the event streaming endpoint with replay support.

**Endpoint:** `GET /api/v1/runs/:runId/stream`

**Deliverables:**
- `src/backend/lib/event-stream.ts` — EventBuffer and event emission
- Chunked transfer encoding with keepalives
- `?after=<eventId>` replay support
- In-memory circular buffer (10,000 events)

**Dependencies:** Task 2.2  

**Required Tests:**
- Events stream as NDJSON lines
- Keepalive comments sent every 15s
- Replay with `?after=` returns correct events
- Monotonic sequence numbers (gap-free)
- Buffer eviction works correctly

**Acceptance Criteria (from spec 09):**
- All event types from spec 09 §2 supported
- Connection survives client reconnect with replay
- Events include eventId, seq, timestamp, type, runId, data

---

#### Task 2.4: REST API Endpoints - Tasks
**Complexity:** Small  
**Description:** Implement task listing and detail endpoints.

**Endpoints:**
| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/api/v1/runs/:runId/tasks` | List tasks |
| `GET` | `/api/v1/runs/:runId/tasks/:taskId` | Get task detail |

**Dependencies:** Task 1.4, Task 2.1  

**Required Tests:**
- List returns all tasks with summaries
- Detail includes walkthrough content when available
- 404 for non-existent task
- Status reflects dag-status.json

---

#### Task 2.5: REST API Endpoints - Artifacts
**Complexity:** Small  
**Description:** Implement artifact retrieval endpoint.

**Endpoint:** `GET /api/v1/runs/:runId/artifacts/:path`

**Dependencies:** Task 1.4, Task 2.1  

**Required Tests:**
- Returns raw file content
- Correct Content-Type based on extension
- 404 for non-existent artifact
- Path traversal prevention

---

#### Task 2.6: REST API Endpoints - Change Requests
**Complexity:** Small  
**Description:** Implement change request listing and approval.

**Endpoints:**
| Method | Path | Description |
|--------|------|-------------|
| `GET` | `/api/v1/runs/:runId/change-requests` | List CRs |
| `POST` | `/api/v1/runs/:runId/change-requests/:crId/approve` | Approve CR |

**Dependencies:** Task 1.4, Task 2.1  

**Required Tests:**
- List returns all CRs with status
- Approve transitions CR to approved
- 409 if CR not in pending status
- 404 for non-existent CR

---

#### Task 2.7: Captain Messaging Endpoint
**Complexity:** Small  
**Description:** Implement the Captain message endpoint for interview phase.

**Endpoint:** `POST /api/v1/captain/message`

**Dependencies:** Task 2.2, Task 2.3  

**Required Tests:**
- Message acknowledged with 202
- 409 if run not in planning phase
- Events emitted on stream

---

### Phase 3: DAG & Task Management (Priority: High)

#### Task 3.1: DAG Schema Implementation
**Complexity:** Medium  
**Description:** Implement DAG data structures, validation, and status tracking.

**Deliverables:**
- `src/backend/lib/dag/types.ts` — TypeScript interfaces for DAG, DAGNode
- `src/backend/lib/dag/validation.ts` — Acyclicity check, dangling reference detection
- `src/backend/lib/dag/status.ts` — Status state machine enforcement

**Dependencies:** Task 1.4  

**Required Tests:**
- Cycle detection rejects circular dependencies
- Valid transitions enforced (spec 07 §4)
- Invalid transitions rejected
- Topological sort succeeds for valid DAG
- Dangling dependency references rejected

**Acceptance Criteria (from spec 07):**
- DAG JSON schema matches spec
- All 7 TaskStatus values supported
- Status transitions match state machine diagram

---

#### Task 3.2: Task Markdown Parser
**Complexity:** Small  
**Description:** Parse task files with YAML frontmatter and markdown body.

**Deliverables:**
- `src/backend/lib/task-parser.ts` — Parse task files
- Frontmatter extraction (id, title, type, dependencies, acceptance_criteria, etc.)
- Validation against schema

**Dependencies:** Task 1.4  

**Required Tests:**
- YAML frontmatter parsed correctly
- All required fields validated
- Invalid tasks rejected with clear errors
- Markdown body preserved

---

#### Task 3.3: Change Request Overlay Application
**Complexity:** Medium  
**Description:** Implement CR overlay merge logic for effective DAG computation.

**Deliverables:**
- `src/backend/lib/dag/overlay.ts` — Overlay application
- Append-only semantics enforcement
- Effective DAG computation

**Dependencies:** Task 3.1  

**Required Tests:**
- Overlays applied in appliedAt order
- Added nodes appear in effective DAG
- Added edges create new dependencies
- Overlay validation prevents conflicts
- Cannot modify existing nodes

---

### Phase 4: Tool Implementations (Priority: High)

#### Task 4.1: Coding Tools (fork from coding-agent)
**Complexity:** Medium  
**Description:** Extract and adapt tools from pi-mono coding-agent: read, write, edit, bash, find, grep, ls.

**Deliverables:**
- `src/backend/packages/forge-tools/` package
- `BashOperations` interface for pluggable execution
- `FileOperations` interface for pluggable filesystem
- TUI rendering stripped
- TypeBox schemas preserved

**Dependencies:** Task 1.2  

**Required Tests:**
- Each tool validates parameters via TypeBox
- Read returns file content with optional range
- Write creates file and directories
- Edit applies diff correctly (fails if oldStr not found)
- Bash returns stdout, stderr, exitCode
- Find returns matching files
- Grep returns matching lines

---

#### Task 4.2: Web Tools (Exa AI Integration)
**Complexity:** Small  
**Description:** Implement web_search and web_fetch tools using Exa AI API.

**Deliverables:**
- `src/backend/lib/tools/web-search.ts`
- `src/backend/lib/tools/web-fetch.ts`
- Exa AI SDK integration

**Dependencies:** Task 1.2  

**Required Tests:**
- web_search returns ranked results
- web_fetch returns markdown content
- Error handling for API failures
- Rate limiting/backoff

---

#### Task 4.3: Artifact Tools (Captain Only)
**Complexity:** Small  
**Description:** Implement create_spec, create_task, set_dag tools for Captain.

**Deliverables:**
- `src/backend/lib/tools/create-spec.ts`
- `src/backend/lib/tools/create-task.ts`
- `src/backend/lib/tools/set-dag.ts`

**Dependencies:** Task 1.4, Task 3.1  

**Required Tests:**
- create_spec writes to specs/
- create_task validates frontmatter and writes to tasks/
- set_dag validates DAG and writes dag.json
- Atomic writes used

---

#### Task 4.4: Planning Tools (just-bash Simulation)
**Complexity:** Medium  
**Description:** Implement plan_read, plan_write, plan_bash, plan_edit using just-bash.

**Deliverables:**
- `src/backend/lib/tools/plan-tools.ts`
- just-bash integration for in-memory filesystem
- Isolated from real repo

**Dependencies:** Task 4.1  

**Required Tests:**
- Operations work in just-bash simulation
- Changes don't affect real filesystem
- Supported commands work (find, grep, jq, etc.)
- Error handling for unsupported commands

---

#### Task 4.5: Agent Management Tools
**Complexity:** Medium  
**Description:** Implement spawn_agent and emit_walkthrough tools.

**Deliverables:**
- `src/backend/lib/tools/spawn-agent.ts`
- `src/backend/lib/tools/emit-walkthrough.ts`
- Hierarchy enforcement (Type 2 → Type 1 only, etc.)

**Dependencies:** Task 1.3, Task 1.4  

**Required Tests:**
- spawn_agent enforces hierarchy constraints
- Idempotent (returns existing agent if already spawned)
- emit_walkthrough validates walkthrough schema
- walkthrough.md written to correct location

---

#### Task 4.6: Refinery-Only Tools
**Complexity:** Medium  
**Description:** Implement merge_branches, run_tests, fix_conflict, emit_cr for Refinery agents.

**Deliverables:**
- `src/backend/lib/tools/merge-branches.ts`
- `src/backend/lib/tools/run-tests.ts`
- `src/backend/lib/tools/fix-conflict.ts`
- `src/backend/lib/tools/emit-cr.ts`

**Dependencies:** Task 4.5  

**Required Tests:**
- merge_branches merges git branches
- run_tests executes test command and parses results
- fix_conflict spawns sub-agent for resolution
- emit_cr creates CR and halts executor

---

#### Task 4.7: Executor Tools
**Complexity:** Small  
**Description:** Implement read_spec, read_task, read_dag, read_walkthrough, mark_task_status, prepare_branch.

**Deliverables:**
- `src/backend/lib/tools/executor-tools.ts`

**Dependencies:** Task 1.4, Task 3.1  

**Required Tests:**
- All read operations return correct artifacts
- mark_task_status enforces state machine
- prepare_branch creates branch and merges dependencies

---

### Phase 5: E2B Sandbox Integration (Priority: High)

#### Task 5.1: E2B Sandbox Manager
**Complexity:** Medium  
**Description:** Implement sandbox lifecycle management using @e2b/code-interpreter.

**Deliverables:**
- `src/backend/lib/sandbox/manager.ts` — SandboxManager class
- Create, pause, resume, kill operations
- Metadata tracking (taskId, attemptId, etc.)
- Environment variable injection

**Dependencies:** Task 1.1  

**Required Tests:**
- Sandbox creates from template
- Commands execute and return results
- File operations work
- Pause/resume preserves state
- Sandbox kills cleanly
- Metadata stored correctly

**Acceptance Criteria (from spec 06):**
- ~150ms boot time from template
- 1-hour runtime with pause/resume
- GitHub credentials injected at runtime

---

#### Task 5.2: Git Operations in Sandbox
**Complexity:** Medium  
**Description:** Implement git operations: clone, checkout, merge, commit, push.

**Deliverables:**
- `src/backend/lib/sandbox/git.ts`
- Branch naming: `forge/<taskId>/<attemptId>`
- Structured commit messages
- Exponential backoff for remote operations

**Dependencies:** Task 5.1  

**Required Tests:**
- Clone works with auth token
- Branch creation follows naming convention
- Dependency branches merge correctly
- Push with backoff/retry
- Commit message format correct

---

### Phase 6: Agent Orchestration (Priority: Critical)

#### Task 6.1: Captain Agent Implementation
**Complexity:** Large  
**Description:** Implement the Captain agent for planning interviews.

**Deliverables:**
- `src/backend/lib/agents/captain.ts`
- System prompt for Captain behavior
- Tool registration (codebase + simulation + web + artifact tools)
- Conversation history management
- Artifact generation flow

**Dependencies:** Task 1.3, Task 4.1, Task 4.2, Task 4.3, Task 4.4, Task 5.1  

**Required Tests:**
- Interview flow progresses through phases
- Tools accessible and functional
- Artifacts created correctly
- Plan finalization emits correct event
- CR re-invocation for mini-replan

**Acceptance Criteria (from spec 02):**
- Brownfield vs greenfield detection
- Thorough questioning before artifact generation
- DAG maximizes parallelism, minimizes conflicts
- Refinery placement at integration points

---

#### Task 6.2: Worker Agent Types (1, 2, 3)
**Complexity:** Large  
**Description:** Implement the three worker agent types with hierarchy enforcement.

**Deliverables:**
- `src/backend/lib/agents/type1.ts` — Throwaway agent
- `src/backend/lib/agents/type2.ts` — Default worker
- `src/backend/lib/agents/type3.ts` — Sub-executor
- System prompts per type
- Tool set per type (per spec 05)

**Dependencies:** Task 1.3, Task 4.1, Task 4.5  

**Required Tests:**
- Type 1 cannot spawn sub-agents
- Type 2 can only spawn Type 1
- Type 3 can spawn Type 1 and 2
- Subtask list persistence for Type 3
- Walkthrough emission required

**Acceptance Criteria (from spec 04):**
- Heartbeat every 30s
- Progress events streamed
- Tool events emitted
- Sandbox lifecycle managed

---

#### Task 6.3: Refinery Agent Implementation
**Complexity:** Large  
**Description:** Implement the Refinery agent for integration and validation.

**Deliverables:**
- `src/backend/lib/agents/refinery.ts`
- Branch merging logic
- Test execution and validation
- Conflict resolution via sub-agents
- Change request emission

**Dependencies:** Task 6.2, Task 4.6  

**Required Tests:**
- Merges all upstream branches
- Runs tests and reports results
- Spawns sub-agents for conflicts
- Emits CR when plan needs revision
- Gated mode waits for approval

---

#### Task 6.4: Executor Loop Implementation
**Complexity:** Large  
**Description:** Implement the central orchestration loop.

**Deliverables:**
- `src/backend/lib/executor/loop.ts`
- DAG traversal logic
- Agent spawning (idempotent)
- Heartbeat monitoring
- Walkthrough review
- CR handling and pause/resume

**Dependencies:** Task 3.1, Task 5.1, Task 6.2, Task 6.3  

**Required Tests:**
- Ready tasks identified correctly
- Agents spawned for ready tasks
- Idempotent spawning (no double-spawn)
- Heartbeat timeout marks STALE
- Walkthrough review identifies risks/followups
- CR halts execution
- Retry logic with new attemptId

**Acceptance Criteria (from spec 03):**
- Single-writer lock prevents race conditions
- All event types from spec emitted
- Dynamic agent spawning for followups
- State machine transitions enforced

---

### Phase 7: SDK & Final Integration (Priority: Medium)

#### Task 7.1: TypeScript SDK Implementation
**Complexity:** Medium  
**Description:** Implement the ForgeSDK client class.

**Deliverables:**
- `src/backend/packages/forge-sdk/` package
- All methods from spec 09 §3
- AsyncIterable for event streaming
- Typed error handling

**Dependencies:** Task 2.2, Task 2.3, Task 2.4, Task 2.5, Task 2.6, Task 2.7  

**Required Tests:**
- All SDK methods work correctly
- Event stream reconnection with replay
- Error types thrown correctly
- TypeScript types match API responses

---

#### Task 7.2: Integration Testing Suite
**Complexity:** Medium  
**Description:** End-to-end tests for complete workflows.

**Deliverables:**
- E2E test for planning phase
- E2E test for execution phase
- E2E test for CR flow
- Mock E2B sandbox for CI

**Dependencies:** All previous tasks  

**Required Tests:**
- Full run lifecycle (create → plan → execute → complete)
- Pause/resume workflow
- CR emission and replan
- Error recovery and retry

---

---

## API Contracts

*Document API endpoints that frontend depends on:*

| Endpoint | Method | Description | Status |
|----------|--------|-------------|--------|
| `/api/v1/runs` | POST | Create new run | Not Started |
| `/api/v1/runs/:runId` | GET | Get run state | Not Started |
| `/api/v1/runs/:runId/stream` | GET | NDJSON event stream | Not Started |
| `/api/v1/runs/:runId/pause` | POST | Pause run | Not Started |
| `/api/v1/runs/:runId/resume` | POST | Resume run | Not Started |
| `/api/v1/runs/:runId/tasks` | GET | List tasks | Not Started |
| `/api/v1/runs/:runId/tasks/:taskId` | GET | Get task detail | Not Started |
| `/api/v1/runs/:runId/artifacts/:path` | GET | Get artifact | Not Started |
| `/api/v1/runs/:runId/change-requests` | GET | List CRs | Not Started |
| `/api/v1/runs/:runId/change-requests/:crId/approve` | POST | Approve CR | Not Started |
| `/api/v1/captain/message` | POST | Send message to Captain | Not Started |

---

## Database Schema Considerations

**MVP uses JSON files on local filesystem — no database required.**

Artifact store structure serves as persistence:
- `artifacts/<runId>/run-state.json` — Run metadata
- `artifacts/<runId>/dag.json` — Task graph
- `artifacts/<runId>/dag-status.json` — Runtime status
- `artifacts/<runId>/tasks/*.md` — Task definitions
- `artifacts/<runId>/specs/*.md` — Specifications
- `artifacts/<runId>/<taskId>/<attemptId>/walkthrough.md` — Agent output

---

## Dependencies & Environment

### NPM Packages Required

```json
{
  "dependencies": {
    "express": "^4.18",
    "@sinclair/typebox": "^0.32",
    "ajv": "^8.12",
    "@e2b/code-interpreter": "latest",
    "exa-js": "latest",
    "just-bash": "latest"
  },
  "devDependencies": {
    "typescript": "^5.3",
    "@types/express": "^4.17",
    "@types/node": "^20",
    "vitest": "^1.0",
    "eslint": "^8.56",
    "prettier": "^3.2"
  }
}
```

### pi-mono Fork Dependencies
Will be resolved during fork process — see spec 11 for complete list.

### Environment Variables Required

```bash
FORGE_MODEL=claude-sonnet-4-20250514    # Global model for all agents
E2B_API_KEY=e2b_...                      # E2B sandbox API key
EXA_API_KEY=exa_...                      # Exa AI search API key
GITHUB_TOKEN=ghp_...                     # GitHub personal access token
ANTHROPIC_API_KEY=sk-ant-...             # LLM provider key (example)
PORT=3001                                 # Server port
NODE_ENV=development                      # Environment
```

---

## Completed Tasks

### 2026-02-09

- **Task 1.1: Project Scaffolding and Configuration** — Added `src/backend/` Node+TypeScript project with ESLint, Prettier, Vitest, and required npm scripts; validators pass.

---

## Blockers / Notes

### Critical Decisions Made

1. **No Database for MVP**: Using filesystem-based artifact store per spec
2. **Single Global Model**: All agents use `FORGE_MODEL` — no per-agent override
3. **Local-Only Deployment**: No auth layer, localhost CORS only
4. **MCP Deferred**: MCP support explicitly deferred per spec

### Risks Identified

1. **pi-mono Fork Complexity**: Forking packages may have hidden dependencies
2. **E2B Integration**: Sandbox boot time and reliability critical for UX
3. **Event Stream Reliability**: Reconnection and replay must be bulletproof
4. **Git Merge Conflicts**: DAG design must truly minimize conflicts

### Open Questions

1. Template ID for E2B custom template — needs to be built first
2. Exact model identifiers in forge-ai model registry
3. just-bash supported command set for plan_* tools

---

*When all tasks are complete, add "ALL TASKS COMPLETE" to signal the loop to stop.*
